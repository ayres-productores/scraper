{% extends "base.html" %}

{% block title %}{{ titulo }} - Portal de Seguros{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ titulo }}</h1>
    <a href="{{ url_for('distribucion.plantillas') }}" class="btn btn-outline">&#8592; Volver</a>
</div>

<div class="grid-2">
    <div class="card">
        <div class="card-body">
            <form method="POST">
                {{ form.hidden_tag() }}

                <div class="form-group">
                    <label for="nombre_plantilla">Nombre de la Plantilla *</label>
                    {{ form.nombre_plantilla(class="form-control", placeholder="Ej: Mensaje Estándar") }}
                    {% if form.nombre_plantilla.errors %}
                    <span class="error-text">{{ form.nombre_plantilla.errors[0] }}</span>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="mensaje">Mensaje *</label>
                    {{ form.mensaje(class="form-control", rows="12", placeholder="Escribe tu mensaje aquí...") }}
                    {% if form.mensaje.errors %}
                    <span class="error-text">{{ form.mensaje.errors[0] }}</span>
                    {% endif %}
                    <small class="form-text">Usa las variables del panel derecho para personalizar el mensaje</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        {{ form.es_predeterminada(class="checkbox") }}
                        <span>&#11088; Usar como plantilla predeterminada</span>
                    </label>
                    <small class="form-text">Esta plantilla se usará automáticamente para clientes con "mensaje estándar"</small>
                </div>

                <div class="form-actions">
                    <a href="{{ url_for('distribucion.plantillas') }}" class="btn btn-outline">Cancelar</a>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>&#128204; Variables Disponibles</h2>
        </div>
        <div class="card-body">
            <p class="text-muted">Haz clic en una variable para insertarla:</p>

            <div class="variables-grid">
                {% for variable, descripcion in variables.items() %}
                <button type="button" class="variable-btn" onclick="insertarVariable('{{ variable }}')">
                    <code>{{ variable }}</code>
                    <small>{{ descripcion }}</small>
                </button>
                {% endfor %}
            </div>

            <div class="preview-section">
                <h4>Vista Previa</h4>
                <div class="preview-box" id="preview">
                    <p class="text-muted">Escribe un mensaje para ver la vista previa...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.variables-grid {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.variable-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    background: var(--light);
    border: 1px solid var(--gray-light);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
}

.variable-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.variable-btn:hover code {
    background: rgba(255,255,255,0.2);
    color: white;
}

.variable-btn code {
    background: var(--dark);
    color: var(--success);
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-size: 0.8rem;
}

.variable-btn small {
    color: var(--gray);
    font-size: 0.8rem;
}

.variable-btn:hover small {
    color: rgba(255,255,255,0.8);
}

.preview-section {
    border-top: 1px solid var(--gray-light);
    padding-top: 1rem;
}

.preview-section h4 {
    font-size: 0.9rem;
    color: var(--gray);
    margin-bottom: 0.75rem;
}

.preview-box {
    background: var(--light);
    padding: 1rem;
    border-radius: var(--radius-sm);
    white-space: pre-wrap;
    font-size: 0.9rem;
    min-height: 100px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function insertarVariable(variable) {
    const textarea = document.getElementById('mensaje');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;

    textarea.value = text.substring(0, start) + variable + text.substring(end);
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = start + variable.length;

    actualizarPreview();
}

function actualizarPreview() {
    const mensaje = document.getElementById('mensaje').value;
    const preview = document.getElementById('preview');

    if (!mensaje.trim()) {
        preview.innerHTML = '<p class="text-muted">Escribe un mensaje para ver la vista previa...</p>';
        return;
    }

    // Simular variables con datos de ejemplo
    let texto = mensaje
        .replace(/{nombre}/g, '<strong>Juan</strong>')
        .replace(/{apellido}/g, '<strong>Pérez</strong>')
        .replace(/{nombre_completo}/g, '<strong>Juan Pérez</strong>')
        .replace(/{compania}/g, '<strong>Mapfre</strong>')
        .replace(/{tipo_seguro}/g, '<strong>Automóvil</strong>')
        .replace(/{numero_poliza}/g, '<strong>POL-123456</strong>')
        .replace(/{vigencia_desde}/g, '<strong>01/01/2026</strong>')
        .replace(/{vigencia_hasta}/g, '<strong>01/01/2027</strong>')
        .replace(/{prima}/g, '<strong>450.00</strong>')
        .replace(/\n/g, '<br>');

    preview.innerHTML = texto;
}

document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('mensaje');
    textarea.addEventListener('input', actualizarPreview);
    actualizarPreview();
});
</script>
{% endblock %}
